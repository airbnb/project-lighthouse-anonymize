name: Publish to TestPyPI
# TODO: Switch to PyPI - rename workflow to "Publish to PyPI"

# Actions are pinned to full SHAs to prevent supply chain attacks (tag hijacking).
# TODO(Later): Consider using Dependabot to automate SHA updates, or switch to tags
# if the maintenance burden outweighs the security benefit for this project.

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: read
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    # TODO: Switch to PyPI - change environment name to "PyPI" and url to https://pypi.org/p/project-lighthouse-anonymize
    environment:
      name: TestPyPI
      url: https://test.pypi.org/p/project-lighthouse-anonymize
    permissions:
      attestations: write
      contents: read
      id-token: write

    steps:
    - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1
      with:
        fetch-depth: 0  # For hatch-vcs

    - name: Set up Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
      with:
        python-version: "3.12"

    - name: Install dependencies
      run: |
        pip install build hatch hatch-vcs

    - name: Build package
      run: python -m build

    - name: Verify package installation
      run: |
        pip install dist/*.whl
        pip check

    - name: Attest build provenance
      uses: actions/attest-build-provenance@62fc1d596301d0ab9914e1fec14dc5c8d93f65cd  # v3.2.0
      with:
        subject-path: dist/*.whl

    # TODO: Uncomment to enable publishing
    # - name: Publish to TestPyPI
    #   uses: pypa/gh-action-pypi-publish@4bb033805d9e19112d8c697528791ff53f6c2f74  # v1.9.0
    #   with:
    #     repository-url: https://test.pypi.org/legacy/
    #     print-hash: true

    # TODO: Switch to PyPI - uncomment PyPI block below and delete TestPyPI block above it
    # - name: Publish to PyPI
    #   uses: pypa/gh-action-pypi-publish@4bb033805d9e19112d8c697528791ff53f6c2f74  # v1.9.0
    #   with:
    #     print-hash: true
